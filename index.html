<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>WARZONE: FINAL FIXED</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; user-select: none; font-family: 'Segoe UI', sans-serif; }
        
        /* UI LAYERS */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; display: none; }
        
        /* DEATH SCREEN */
        #death-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(100, 0, 0, 0.8); z-index: 100; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #death-msg { font-size: 3rem; color: red; font-weight: 900; text-shadow: 2px 2px black; margin-bottom: 20px; }
        #respawn-btn {
            padding: 15px 40px; background: #fff; color: #000; font-size: 1.5rem; border: none;
            font-weight: bold; cursor: pointer; border-radius: 8px; pointer-events: auto;
        }

        /* ADMIN BUTTON */
        #admin-btn-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            pointer-events: auto; z-index: 20;
        }
        #admin-btn {
            background: rgba(0,0,0,0.6); border: 2px solid #00ff00; color: #00ff00;
            padding: 8px 16px; font-weight: bold; border-radius: 4px; cursor: pointer;
            font-size: 14px; text-shadow: 0 0 5px #00ff00;
        }
        #admin-btn.active { background: #00ff00; color: #000; box-shadow: 0 0 15px #00ff00; }

        /* TOASTS */
        #chat-toasts {
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%);
            width: 80%; display: flex; flex-direction: column; align-items: center; gap: 5px;
            pointer-events: none; z-index: 30;
        }
        .toast-msg {
            background: rgba(0, 0, 0, 0.7); color: #fff; padding: 5px 10px;
            border-radius: 20px; font-size: 12px; border: 1px solid rgba(255,255,255,0.3);
            animation: fadeOut 4s forwards;
        }
        @keyframes fadeOut { 0% { opacity: 0; transform: translateY(-10px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; } 100% { opacity: 0; display: none; } }

        /* CHAT */
        #chat-toggle {
            position: absolute; top: 10px; left: 10px; pointer-events: auto;
            width: 40px; height: 40px; background: rgba(0,0,0,0.5); border: 1px solid #fff;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            color: #fff; font-size: 20px; z-index: 25; cursor: pointer;
        }
        #chat-wrap {
            position: absolute; top: 60px; left: 10px; width: 250px; height: 150px;
            pointer-events: auto; display: none; flex-direction: column; z-index: 25;
            background: rgba(0,0,0,0.8); border: 1px solid #555; border-radius: 8px;
        }
        #chat-msgs { flex: 1; overflow-y: auto; color: #fff; font-size: 12px; padding: 5px; scrollbar-width: none; }
        #chat-input-row { display: flex; padding: 5px; border-top: 1px solid #444; }
        #chat-input { flex: 1; background: rgba(255,255,255,0.1); border: none; color: white; padding: 4px; border-radius: 4px; outline: none; }
        #chat-send { background: #00ff00; border: none; padding: 0 10px; font-weight: bold; border-radius: 4px; margin-left: 5px; cursor: pointer; }

        /* HUD */
        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; transform: translate(-50%, -50%); pointer-events: none; }
        .ch-line { position: absolute; background: #fff; box-shadow: 0 0 2px #000; }
        .ch-h { width: 20px; height: 2px; top: 9px; left: 0; }
        .ch-v { width: 2px; height: 20px; top: 0; left: 9px; }

        .hud-stats { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .stat-box { font-size: 1.2rem; font-weight: bold; text-shadow: 1px 1px 2px #000; white-space: nowrap; }
        .hp { color: #ff3333; } .ammo { color: #ffcc00; }

        /* CONTROLS */
        #joystick-zone {
            position: absolute; bottom: 30px; left: 30px; width: 120px; height: 120px;
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%; pointer-events: auto; touch-action: none;
        }
        #stick-knob {
            position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
            background: rgba(255,255,255,0.5); border-radius: 50%;
            transform: translate(-50%, -50%); pointer-events: none;
        }
        .action-btn {
            position: absolute; border-radius: 50%; pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; color: white; backdrop-filter: blur(4px); touch-action: none;
        }
        #btn-fire { bottom: 50px; right: 30px; width: 80px; height: 80px; background: rgba(255, 50, 50, 0.4); border: 3px solid red; }
        #btn-fire:active { background: rgba(255, 50, 50, 0.8); }
        #btn-jump { bottom: 150px; right: 40px; width: 60px; height: 60px; background: rgba(255,255,255,0.2); border: 2px solid #fff; }
        #btn-scope { bottom: 60px; right: 130px; width: 50px; height: 50px; background: rgba(255,255,255,0.2); border: 2px solid #fff; font-size: 10px; }

        /* LOADING */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; display: flex; justify-content: center; align-items: center;
            color: #00ff00; font-family: monospace; font-size: 20px; z-index: 100;
        }

        /* ADMIN MODAL */
        #admin-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-box { background: #111; padding: 20px; border: 1px solid #00ff00; text-align: center; border-radius: 8px; }
        .modal-inp { padding: 10px; background: #000; border: 1px solid #333; color: #00ff00; text-align: center; font-size: 18px; width: 150px; }
        .modal-btn { padding: 10px 20px; background: #00ff00; color: #000; border: none; font-weight: bold; margin-top: 10px; cursor: pointer; }
    </style>
    
    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <div id="loader">CONNECTING TO BATTLEFIELD...</div>

    <div id="game-ui">
        <div id="admin-btn-container"><button id="admin-btn" onclick="toggleAdmin()">ADMIN</button></div>
        <div class="hud-stats">
            <div class="stat-box hp">HP: <span id="hp-val">100</span></div>
            <div class="stat-box ammo">AMMO: <span id="ammo-val">30</span></div>
        </div>
        <div id="crosshair"><div class="ch-line ch-h"></div><div class="ch-line ch-v"></div></div>
        <div id="chat-toasts"></div>
        <div id="chat-toggle" onclick="toggleChatUi()">ðŸ’¬</div>
        <div id="chat-wrap">
            <div id="chat-msgs"></div>
            <div id="chat-input-row"><input type="text" id="chat-input" placeholder="Say something..."><button id="chat-send">></button></div>
        </div>
        <div id="joystick-zone"><div id="stick-knob"></div></div>
        <div id="btn-fire" class="action-btn"></div>
        <div id="btn-jump" class="action-btn">JUMP</div>
        <div id="btn-scope" class="action-btn">AIM</div>
    </div>

    <div id="death-screen">
        <div id="death-msg">YOU DIED</div>
        <button id="respawn-btn" onclick="respawn()">PLAY AGAIN</button>
    </div>

    <div id="admin-modal">
        <div class="modal-box">
            <h3 style="color:#00ff00; margin-top:0;">GOD MODE</h3>
            <input type="password" id="admin-code" class="modal-inp" maxlength="4">
            <br>
            <button class="modal-btn" onclick="verifyAdmin()">ACCESS</button>
            <button class="modal-btn" style="background:#333; color:#fff" onclick="closeModal()">CANCEL</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBJ6YSWR1CkjCc58fRopdWtiuI_NGedUEo",
      authDomain: "gemini-multiplayer-948fe.firebaseapp.com",
      databaseURL: "https://gemini-multiplayer-948fe-default-rtdb.firebaseio.com",
      projectId: "gemini-multiplayer-948fe",
      storageBucket: "gemini-multiplayer-948fe.firebasestorage.app",
      messagingSenderId: "312734987383",
      appId: "1:312734987383:web:2aa0ea9caa5f0c8cfd8272"
    };

    let db, playersRef, chatRef;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        playersRef = db.ref("players");
        chatRef = db.ref("chat");
    } catch(e) { console.error("Firebase Error:", e); alert("Check Console for Firebase Error"); }

    const myId = "P_" + Math.floor(Math.random()*100000);
    const joinTime = Date.now();
    let scene, camera, renderer, world, playerBody;
    let pitchObj = new THREE.Object3D(), yawObj = new THREE.Object3D();
    let otherPlayers = {};
    let shootableMeshes = [];
    
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    let hp = 100;
    let ammo = 30;
    const MAX_AMMO = 30;
    let isScoped = false, isGodMode = false, isDead = false;
    let lastShot = 0;
    let isChatOpen = false;
    
    let move = { f:0, b:0, l:0, r:0 };
    let touchData = { moveId:null, lookId:null, startX:0, startY:0, lookX:0, lookY:0 };

    function playPew() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    function genTex(color, type='solid') {
        const c = document.createElement('canvas'); c.width=64; c.height=64;
        const x = c.getContext('2d');
        x.fillStyle = color; x.fillRect(0,0,64,64);
        if(type==='grid') {
            x.strokeStyle = 'rgba(0,0,0,0.2)'; x.lineWidth=2;
            x.strokeRect(0,0,64,64);
        } else if (type==='noise') {
            x.fillStyle = "rgba(0,0,0,0.1)";
            for(let i=0;i<100;i++) x.fillRect(Math.random()*64,Math.random()*64,2,2);
        } else if (type==='box') {
             x.fillStyle = "#8d6e63"; x.fillRect(0,0,64,64);
             x.fillStyle = "#5d4037"; x.fillRect(5,5,54,54);
             x.fillStyle = "#a1887f"; x.fillRect(10,10,44,44);
             x.fillStyle = "yellow"; x.font="20px Arial"; x.fillText("AM", 10, 40);
        }
        const t = new THREE.CanvasTexture(c);
        t.magFilter = THREE.NearestFilter;
        return t;
    }

    function createPlayerMesh() {
        const group = new THREE.Group();
        const matBody = new THREE.MeshLambertMaterial({color:0x0000ff});
        const matHead = new THREE.MeshLambertMaterial({color:0xffff00});
        const matLimb = new THREE.MeshLambertMaterial({color:0x00aa00});

        const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 0.5), matBody);
        body.position.y = 0.75;
        group.add(body);

        const head = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.8, 0.8), matHead);
        head.position.y = 1.9;
        group.add(head);

        const legGeo = new THREE.BoxGeometry(0.4, 1.5, 0.4);
        const legL = new THREE.Mesh(legGeo, matLimb); legL.position.set(-0.3, 0, 0); legL.name="LegL";
        const legR = new THREE.Mesh(legGeo, matLimb); legR.position.set(0.3, 0, 0); legR.name="LegR";
        
        const legGroup = new THREE.Group();
        legGroup.add(legL); legGroup.add(legR);
        group.add(legGroup);

        return { mesh: group, legL: legL, legR: legR };
    }

    function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 20, 120);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        
        world = new CANNON.World();
        world.gravity.set(0, -20, 0);
        const pMat = new CANNON.Material();
        world.addContactMaterial(new CANNON.ContactMaterial(pMat, pMat, { friction: 0.0, restitution: 0.0 }));

        // Player
        const shape = new CANNON.Sphere(1);
        playerBody = new CANNON.Body({ mass: 60, material: pMat, fixedRotation: true });
        playerBody.addShape(shape);
        playerBody.position.set(0, 50, 0); // Sky Drop spawn
        playerBody.linearDamping = 0.9;
        world.addBody(playerBody);

        pitchObj.add(camera);
        yawObj.add(pitchObj);
        yawObj.position.y = 1.6;
        scene.add(yawObj);

        // Lights
        const amb = new THREE.AmbientLight(0xffffff, 0.7);
        scene.add(amb);
        const dir = new THREE.DirectionalLight(0xffffff, 0.8);
        dir.position.set(50, 100, 50);
        scene.add(dir);

        buildMap();

        renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        document.getElementById('loader').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
        
        setupControls();
        setupNet();
        animate(); // Fixed: Calls animate() now
    }

    function buildMap() {
        const fTex = genTex('#2e7d32', 'grid'); fTex.repeat.set(100,100); fTex.wrapS=THREE.RepeatWrapping; fTex.wrapT=THREE.RepeatWrapping;
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(400,400), new THREE.MeshLambertMaterial({map:fTex}));
        floor.rotation.x = -Math.PI/2;
        scene.add(floor);
        
        const fBody = new CANNON.Body({mass:0, shape:new CANNON.Plane()});
        fBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0), -Math.PI/2);
        world.addBody(fBody);

        const wallMat = new THREE.MeshLambertMaterial({map:genTex('#5d4037', 'noise')});
        const crateMat = new THREE.MeshBasicMaterial({map:genTex('#ffcc00', 'box')});
        
        for(let i=0; i<50; i++) {
            const w = 4 + Math.random()*8;
            const h = 4 + Math.random()*10;
            const d = 4 + Math.random()*8;
            const x = (Math.random()-0.5)*300;
            const z = (Math.random()-0.5)*300;
            
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(w,h,d), wallMat);
            mesh.position.set(x, h/2, z);
            scene.add(mesh);
            
            const body = new CANNON.Body({mass:0, position:new CANNON.Vec3(x, h/2, z)});
            body.addShape(new CANNON.Box(new CANNON.Vec3(w/2, h/2, d/2)));
            world.addBody(body);

            if(Math.random() > 0.4) {
                spawnAmmo(x, h + 0.5, z, crateMat);
            }
        }
        
        for(let i=0; i<20; i++) {
             spawnAmmo((Math.random()-0.5)*300, 0.5, (Math.random()-0.5)*300, crateMat);
        }
    }
    
    let pickups = [];
    function spawnAmmo(x, y, z, mat) {
        const mesh = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), mat);
        mesh.position.set(x, y, z);
        scene.add(mesh);
        const body = new CANNON.Body({mass:0, position:new CANNON.Vec3(x, y, z)});
        body.addShape(new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5)));
        world.addBody(body);
        
        pickups.push({mesh:mesh, body:body, active:true});
    }

    function setupNet() {
        // Increased interval to 100ms to prevent rate limiting
        setInterval(() => {
            if(!isDead) {
                playersRef.child(myId).update({
                    x: playerBody.position.x,
                    y: playerBody.position.y,
                    z: playerBody.position.z,
                    rot: yawObj.rotation.y,
                    moving: (move.f||move.b||move.l||move.r)
                });
            }
        }, 100);

        playersRef.on("value", snap => {
            const d = snap.val() || {};
            for(let id in otherPlayers) if(!d[id]) { scene.remove(otherPlayers[id].root); delete otherPlayers[id]; }
            for(let id in d) {
                if(id === myId) continue;
                if(!otherPlayers[id]) {
                    const pObj = createPlayerMesh();
                    scene.add(pObj.mesh);
                    pObj.mesh.userData = { id: id }; 
                    shootableMeshes.push(pObj.mesh);
                    otherPlayers[id] = { root: pObj.mesh, legL: pObj.legL, legR: pObj.legR };
                }
                const p = otherPlayers[id];
                const data = d[id];
                p.root.position.lerp(new THREE.Vector3(data.x, data.y, data.z), 0.3);
                p.root.rotation.y = data.rot;
                
                if(data.moving) {
                    const t = Date.now() * 0.01;
                    p.legL.rotation.x = Math.sin(t) * 0.5;
                    p.legR.rotation.x = -Math.sin(t) * 0.5;
                } else {
                    p.legL.rotation.x = 0;
                    p.legR.rotation.x = 0;
                }
            }
        });

        playersRef.child(myId).child("hits").on("child_added", (snap) => {
            if(isGodMode || isDead) return;
            const dmg = snap.val();
            hp -= dmg;
            document.getElementById('hp-val').innerText = hp;
            snap.ref.remove();
            
            if(hp <= 0) die();
        });

        chatRef.limitToLast(10).on("child_added", s => {
            const v = s.val();
            if(v.time < joinTime) return; 
            if(!isChatOpen) createToast(`${v.id.substr(0,4)}: ${v.msg}`);
            const d = document.createElement('div');
            d.innerHTML = `<b style="color:${v.id===myId?'lime':'orange'}">${v.id.substr(0,4)}:</b> ${v.msg}`;
            document.getElementById('chat-msgs').append(d);
            document.getElementById('chat-msgs').scrollTop = 9999;
        });
        
        document.getElementById('chat-send').onclick = () => {
            const t = document.getElementById('chat-input').value;
            if(t) { chatRef.push({id:myId, msg:t, time:Date.now()}); document.getElementById('chat-input').value=''; }
        }
    }

    function fireBullet() {
        const now = Date.now();
        if(now - lastShot < 150) return;
        lastShot = now;

        if(ammo > 0) {
            playPew();
            if(!isGodMode) { ammo--; document.getElementById('ammo-val').innerText = ammo; }
            
            pitchObj.rotation.x += 0.04; 

            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            
            let targets = [];
            Object.values(otherPlayers).forEach(p => targets.push(p.root));
            
            const intersects = ray.intersectObjects(targets, true);
            
            if(intersects.length > 0) {
                let hitObj = intersects[0].object;
                while(hitObj.parent && !hitObj.userData.id) hitObj = hitObj.parent;
                
                if(hitObj.userData.id) {
                    playersRef.child(hitObj.userData.id).child("hits").push(15);
                }
            }
        }
    }

    function die() {
        isDead = true;
        document.getElementById('game-ui').style.display = 'none';
        document.getElementById('death-screen').style.display = 'flex';
        playersRef.child(myId).remove();
    }

    window.respawn = function() {
        isDead = false;
        hp = 100; ammo = 30;
        document.getElementById('hp-val').innerText = hp;
        document.getElementById('ammo-val').innerText = ammo;
        playerBody.position.set((Math.random()-0.5)*200, 50, (Math.random()-0.5)*200);
        playerBody.velocity.set(0,0,0);
        document.getElementById('death-screen').style.display = 'none';
        document.getElementById('game-ui').style.display = 'block';
    }

    // FIXED: Renamed function to match init() call
    function setupControls() { 
        const joy = document.getElementById('joystick-zone');
        const knob = document.getElementById('stick-knob');
        
        joy.addEventListener('touchstart', e => {
            e.preventDefault(); const t = e.changedTouches[0];
            touchData.moveId = t.identifier; touchData.startX = t.clientX; touchData.startY = t.clientY;
        }, {passive:false});

        joy.addEventListener('touchmove', e => {
            e.preventDefault();
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === touchData.moveId) {
                    const t = e.changedTouches[i];
                    let dx = t.clientX - touchData.startX, dy = t.clientY - touchData.startY;
                    const d = Math.sqrt(dx*dx+dy*dy);
                    if(d>40) { dx=(dx/d)*40; dy=(dy/d)*40; }
                    knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                    move.f = dy<-10; move.b = dy>10; move.l = dx<-10; move.r = dx>10;
                }
            }
        }, {passive:false});

        joy.addEventListener('touchend', e => {
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === touchData.moveId) {
                    touchData.moveId = null; move={f:0,b:0,l:0,r:0};
                    knob.style.transform = `translate(-50%, -50%)`;
                }
            }
        });

        // Look (Attached to document with passive: false)
        document.addEventListener('touchstart', e => {
            for(let i=0; i<e.changedTouches.length; i++) {
                const t = e.changedTouches[i];
                if(t.clientX > window.innerWidth/2 && !t.target.classList.contains('action-btn')) {
                    touchData.lookId = t.identifier; touchData.lookX = t.clientX; touchData.lookY = t.clientY;
                }
            }
        }, {passive:false});

        document.addEventListener('touchmove', e => {
            e.preventDefault(); // Prevent scrolling
            for(let i=0; i<e.changedTouches.length; i++) {
                if(e.changedTouches[i].identifier === touchData.lookId) {
                    const t = e.changedTouches[i];
                    yawObj.rotation.y -= (t.clientX - touchData.lookX)*0.005;
                    pitchObj.rotation.x -= (t.clientY - touchData.lookY)*0.005;
                    pitchObj.rotation.x = Math.max(-1.5, Math.min(1.5, pitchObj.rotation.x));
                    touchData.lookX = t.clientX; touchData.lookY = t.clientY;
                }
            }
        }, {passive:false});

        document.getElementById('btn-jump').addEventListener('touchstart', e=>{ e.preventDefault(); if(playerBody.position.y < 3 || isGodMode) playerBody.velocity.y = isGodMode? 10 : 8; });
        document.getElementById('btn-fire').addEventListener('touchstart', e=>{ e.preventDefault(); fireBullet(); });
        document.getElementById('btn-scope').addEventListener('touchstart', e=>{ e.preventDefault(); isScoped=!isScoped; camera.fov=isScoped?30:75; camera.updateProjectionMatrix(); });
    }

    // FIXED: Renamed update to animate to match init() call
    function animate() {
        requestAnimationFrame(animate);
        const dt = 1/60;
        
        if(!isDead) {
            if(isGodMode) {
                playerBody.velocity.set(0,0,0);
                const speed = 25;
                const dir = new THREE.Vector3();
                if(move.f) dir.z = -1; if(move.b) dir.z = 1;
                if(move.l) dir.x = -1; if(move.r) dir.x = 1;
                dir.applyQuaternion(camera.getWorldQuaternion(new THREE.Quaternion()));
                playerBody.position.add(dir.multiplyScalar(speed * dt));
            } else {
                world.step(dt);
                playerBody.mass = 60;
                const speed = 10;
                const dir = new THREE.Vector3();
                if(move.f) dir.z = -1; if(move.b) dir.z = 1;
                if(move.l) dir.x = -1; if(move.r) dir.x = 1;
                dir.applyEuler(new THREE.Euler(0, yawObj.rotation.y, 0));
                playerBody.velocity.x = dir.x * speed;
                playerBody.velocity.z = dir.z * speed;
            }

            yawObj.position.copy(playerBody.position);
            yawObj.position.y += isGodMode ? 0 : 0.6;
            
            pickups.forEach(p => {
                if(p.active && playerBody.position.distanceTo(p.mesh.position) < 2) {
                    p.active = false; scene.remove(p.mesh); world.removeBody(p.body);
                    ammo = MAX_AMMO; document.getElementById('ammo-val').innerText = ammo;
                }
            });
        }
        renderer.render(scene, camera);
    }

    window.toggleAdmin = function() {
        if(isGodMode) {
            isGodMode = false;
            document.getElementById('admin-btn').innerText = "GET ADMIN";
            document.getElementById('admin-btn').classList.remove('active');
            document.getElementById('hp-val').innerText = hp;
            document.getElementById('hp-val').style.color = "#ff3333";
            ammo = Math.min(ammo, MAX_AMMO); 
            document.getElementById('ammo-val').innerText = ammo;
        } else document.getElementById('admin-modal').style.display = 'flex';
    }
    window.closeModal = function() { document.getElementById('admin-modal').style.display = 'none'; }
    window.verifyAdmin = function() {
        if(document.getElementById('admin-code').value === "7434") {
            isGodMode = true; closeModal();
            document.getElementById('admin-btn').innerText = "LEAVE ADMIN";
            document.getElementById('admin-btn').classList.add('active');
            document.getElementById('hp-val').innerText = "GOD";
            document.getElementById('hp-val').style.color = "#00ff00";
            document.getElementById('ammo-val').innerText = "âˆž";
            ammo = 9999;
        } else alert("ACCESS DENIED");
    }

    window.toggleChatUi = function() {
        const w = document.getElementById('chat-wrap');
        isChatOpen = !isChatOpen;
        w.style.display = isChatOpen ? 'flex' : 'none';
    }
    
    function createToast(msg) {
        const t = document.createElement('div'); t.className = 'toast-msg'; t.innerText = msg;
        document.getElementById('chat-toasts').appendChild(t);
        setTimeout(()=>t.remove(), 4000);
    }

    window.onload = init;
    window.onresize = () => { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
</script>
</body>
</html>
